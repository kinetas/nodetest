<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì»¤ë®¤ë‹ˆí‹° íˆ¬í‘œ</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
        .vote-item { margin-bottom: 10px; padding: 10px; background: #fff; border: 1px solid #ccc; }
        button { margin-left: 5px; }
    </style>
</head>
<body>
    <h1>ì»¤ë®¤ë‹ˆí‹° íˆ¬í‘œ</h1>
    <div id="voteList">Loading...</div>

    <h2>ë‚´ê°€ ìƒì„±í•œ íˆ¬í‘œ</h2>
    <div id="myVoteList">Loading...</div>
    <form id="createVoteForm" enctype="multipart/form-data">
        <input type="text" id="c_title" name="c_title" placeholder="ì œëª©">
        <textarea id="c_contents" name="c_contents" placeholder="ë‚´ìš©"></textarea>
        <input type="file" id="c_image" name="c_image" accept="image/*">
        <button type="submit">íˆ¬í‘œ ìƒì„±</button>
    </form>

    <script>
        // function loadVotes() {
        //     fetch('/api/cVote')
        //         .then(response => response.json())
        //         .then(data => {
        //             const voteList = document.getElementById('voteList');
        //             voteList.innerHTML = '';
        //             if (data.success && data.votes && Array.isArray(data.votes)) {
        //                 data.votes.forEach((vote, index) => {
        //                     const voteDiv = document.createElement('div');
        //                     voteDiv.className = 'vote-item';
        //                     voteDiv.innerHTML = `
        //                         ${index + 1}. 
        //                         <a href="/cVote/details?c_number=${vote.c_number}" target="_blank">${vote.c_title}</a>
        //                         - ì‘ì„±ì: ${vote.u_id}
        //                         (${vote.c_good} ì¢‹ìŒ / ${vote.c_bad} ì‹«ìŒ)
        //                     `;
        //                     voteList.appendChild(voteDiv);
        //                 });
        //             } else {
        //                 voteList.innerHTML = 'íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.';
        //             }
        //         })
        //         .catch(error => console.error("Error loading votes:", error));
        // }

        // function loadMyVotes() {
        //     fetch('/api/cVote/myVotes')
        //         .then(response => response.json())
        //         .then(data => {
        //             const myVoteList = document.getElementById('myVoteList');
        //             myVoteList.innerHTML = '';
        //             if (data.success && data.myVotes && Array.isArray(data.myVotes)) {
        //                 data.myVotes.forEach((vote, index) => {
        //                     const voteDiv = document.createElement('div');
        //                     voteDiv.className = 'vote-item';
        //                     voteDiv.innerHTML = `
        //                         ${index + 1}. ${vote.c_title} (${vote.c_good} ì¢‹ìŒ / ${vote.c_bad} ì‹«ìŒ)
        //                         <p>${vote.c_contents}</p>
        //                         <button onclick="deleteVote('${vote.c_number}')">ì‚­ì œ</button>
        //                     `;
        //                     myVoteList.appendChild(voteDiv);
        //                 });
        //             } else {
        //                 myVoteList.innerHTML = 'ë‚´ê°€ ìƒì„±í•œ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.';
        //             }
        //         })
        //         .catch(error => console.error("Error loading my votes:", error));
        // }

        // document.getElementById('createVoteForm').addEventListener('submit', (e) => {
        //     e.preventDefault();
        //     const c_title = document.getElementById('c_title').value.trim();
        //     const c_contents = document.getElementById('c_contents').value.trim();
        //     const c_image = document.getElementById('c_image').files[0];

        //     if (!c_title || !c_contents) {
        //         alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        //         return;
        //     }

        //     if (c_image && c_image.size > 64 * 1024) { // 64KB ì œí•œ
        //         alert("ì´ë¯¸ì§€ íŒŒì¼ í¬ê¸°ëŠ” 64KBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        //         return;
        //     }

        //     const formData = new FormData();
        //     formData.append('c_title', c_title);
        //     formData.append('c_contents', c_contents);
        //     if (c_image) {
        //         formData.append('c_image', c_image);
        //     }

        //     fetch('/api/cVote/create', {
        //         method: 'POST',
        //         body: formData,
        //     })
        //         .then(response => response.json())
        //         .then(data => {
        //             if (data.success) {
        //                 alert('íˆ¬í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        //                 location.reload();
        //             } else {
        //                 alert(data.message);
        //             }
        //         })
        //         .catch(error => console.error("Error creating vote:", error));
        // });

        // function deleteVote(c_number) {
        //     fetch(`/api/cVote/delete/${c_number}`, { method: 'DELETE' })
        //         .then(response => response.json())
        //         .then(data => {
        //             if (data.success) {
        //                 alert('íˆ¬í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        //                 loadMyVotes();
        //             } else {
        //                 alert(data.message);
        //             }
        //         })
        //         .catch(error => console.error("Error deleting vote:", error));
        // }

        // loadVotes();
        // loadMyVotes();

        //====================================token==================================================

        // âœ… JWT í† í° ê°€ì ¸ì˜¤ê¸°
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            location.href = "/";
        }

        function viewVoteDetails(c_number) {
            window.open(`/cVote/details?c_number=${c_number}`, '_blank');
        }

        // âœ… íˆ¬í‘œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜í™”
        function loadVotes() {
            fetch("/nodetest/api/cVote", {
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            })
            .then((res) => res.json())
            .then((data) => {
                const voteList = document.getElementById("voteList");
                voteList.innerHTML = "";

                data.votes.forEach((vote) => {
                    const div = document.createElement("div");
                    div.innerHTML = `
                        <h3>${vote.c_title}</h3>
                        <p>${vote.c_contents}</p>
                        <p>ì¢‹ì•„ìš”: ${vote.c_good} / ì‹«ì–´ìš”: ${vote.c_bad}</p>
                        <button onclick="viewVoteDetails('${vote.c_number}')">ìƒì„¸ ë³´ê¸°</button>
                        <hr />
                    `;
                    voteList.appendChild(div);
                });
            })
            .catch((err) => {
                console.error("íˆ¬í‘œ ëª©ë¡ ì˜¤ë¥˜:", err);
            });
        }

        function loadMyVotes() {
            fetch("/nodetest/api/cVote/myVotes", {
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            })
            .then(res => res.json())
            .then(data => {
                const myVoteList = document.getElementById("myVoteList");
                myVoteList.innerHTML = "";

                if (data.success && Array.isArray(data.myVotes) && data.myVotes.length > 0) {
                    data.myVotes.forEach((vote, index) => {
                        const div = document.createElement("div");
                        div.innerHTML = `
                            <strong>${index + 1}. ${vote.c_title}</strong>
                            <p>${vote.c_contents}</p>
                            <p>ğŸ‘ ${vote.c_good} / ğŸ‘ ${vote.c_bad}</p>
                            <button onclick="deleteVote('${vote.c_number}')">ì‚­ì œ</button>
                            <hr />
                        `;
                        myVoteList.appendChild(div);
                    });
                } else {
                    myVoteList.innerHTML = "ë‚´ê°€ ìƒì„±í•œ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.";
                }
            })
            .catch(err => {
                console.error("ë‚´ íˆ¬í‘œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
                document.getElementById("myVoteList").innerText = "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
            });
        }

        // âœ… íˆ¬í‘œ ë“±ë¡ (ì¢‹ì•„ìš”/ì‹«ì–´ìš”)
        function vote(c_number, action) {
            fetch("/nodetest/api/cVote/action", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ c_number, action }),
            })
            .then((res) => res.json())
            .then((data) => {
                alert(data.message || "íˆ¬í‘œ ì„±ê³µ!");
                loadVotes();
                loadMyVotes();
            })
            .catch((err) => {
                console.error("íˆ¬í‘œ ì‹¤íŒ¨:", err);
            });
        }

        // âœ… íˆ¬í‘œ ìƒì„± í¼ ì´ë²¤íŠ¸
        const voteForm = document.getElementById("createVoteForm");
        voteForm.addEventListener("submit", (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append("c_title", document.getElementById("c_title").value);
            formData.append("c_contents", document.getElementById("c_contents").value);
            const file = document.getElementById("c_image").files[0];
            if (file) {
                if (file.size > 64 * 1024) {
                    alert("ì´ë¯¸ì§€ ìš©ëŸ‰ì€ 64KBë¥¼ ë„˜ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                formData.append("c_image", file);
            }

            fetch("/nodetest/api/cVote/create", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`
                },
                body: formData,
            })
            .then((res) => res.json())
            .then((data) => {
                alert(data.message || "íˆ¬í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadVotes();
                loadMyVotes();
            })
            .catch((err) => {
                console.error("íˆ¬í‘œ ìƒì„± ì˜¤ë¥˜:", err);
            });
        });

        function deleteVote(c_number) {
            fetch(`/nodetest/api/cVote/delete/${c_number}`, {
                method: "DELETE",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            })
            .then((res) => res.json())
            .then((data) => {
                if (data.success) {
                    alert("íˆ¬í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadMyVotes();
                    loadVotes();
                } else {
                    alert(data.message || "ì‚­ì œ ì‹¤íŒ¨");
                }
            })
            .catch((err) => {
                console.error("íˆ¬í‘œ ì‚­ì œ ì˜¤ë¥˜:", err);
            });
        }

        // âœ… ì´ˆê¸° ë¡œë”© ì‹œ ëª©ë¡ í˜¸ì¶œ
        loadVotes();
        loadMyVotes();
    </script>
</body>
</html>