<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ…ë°©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>
    <h1>ì±„íŒ…ë°©</h1>
    <div id="chatMessages">ë©”ì‹œì§€ ëª©ë¡</div>
    <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
    <input type="file" id="fileInput">
    <button onclick="sendMessage()">ì „ì†¡</button>
    <button onclick="goBackToRoomList()">ë‚˜ê°€ê¸°</button>

    <h2>ì±„íŒ…ë°© ìµœê·¼ ë©”ì‹œì§€</h2>
    <div id="lastMessage">ë¡œë”© ì¤‘...</div>

    <h1>ë°© ë¯¸ì…˜ ì¶œë ¥</h1>
    <div>
        <input type="text" id="u2_id_input" placeholder="ìƒëŒ€ë°© ID ì…ë ¥"    >
        <button onclick="printRoomMission()">ë°© ë¯¸ì…˜ ì¶œë ¥</button>
    </div>
    <h2>ë¯¸ì…˜ ëª©ë¡</h2>
    <ul id="roomMissionList"></ul>
    

    <script>
        //========================================token=========================================

        // JWT ë””ì½”ë”© í•¨ìˆ˜ ì¶”ê°€
        function parseJwt(token) {
            try {
                const base64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
                const json = decodeURIComponent(atob(base64).split('').map(c => {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(json);
            } catch (e) {
                return null;
            }
        }
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('r_id');
        const u2_id = urlParams.get('u2_id');
        const token = localStorage.getItem('jwt_token');
        const decoded = parseJwt(token);
        const u1_id = decoded?.userId;

        // ì´ í† í°ê³¼ u1_idê°€ ì‹¤ì œë¡œ ìˆëŠ”ì§€ ì½˜ì†”ì— ì¶œë ¥
        console.log("JWT:", token);
        console.log("ìœ ì € ID:", u1_id);

        // âœ… Socket.io ì—°ê²°: authë¡œ JWT í† í° ì „ë‹¬
        const socket = io("http://27.113.11.48:3001", {
            path: '/socket.io',
            // auth: { token, u1_id, u2_id }
            auth: { token }
        });

        // âœ… í˜ì´ì§€ ë¡œë“œì‹œ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = function() {
            fetch(`/nodetest/chat/messages/${roomId}`, {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            })
            .then(res => res.json())
            .then(messages => {
                const chatMessages = document.getElementById("chatMessages");
                chatMessages.innerHTML = "";

                messages.forEach(data => {
                const messageElement = document.createElement("div");
                const utcDate = new Date(data.send_date);
                const kstDate = new Date(utcDate.getTime() + (9 * 60 * 60 * 1000));
                const formattedDate = kstDate.toISOString().slice(0, 19).replace('T', ' ');

                messageElement.textContent = `[${formattedDate}] ${data.u1_id}: ${data.message_contents}`;

                if (data.image) {
                    const img = document.createElement("img");
                    // img.src = `data:image/jpeg;base64,${data.image}`;
                    img.src = `data:${data.image_type};base64,${data.image}`;
                    img.style.maxWidth = "200px";
                    messageElement.appendChild(img);
                }

                chatMessages.appendChild(messageElement);
                });
            });
        };

        // ì±„íŒ…ë°© ìµœê·¼ ë©”ì‹œì§€
        async function loadLastMessage() {
        try {
            const response = await fetch(`/chat/last-message/${roomId}`);
            if (!response.ok) throw new Error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');

            const data = await response.json();

            const msgBox = document.getElementById('lastMessage');
            msgBox.innerHTML = `
            <p><strong>${data.sender}</strong>: ${data.content}</p>
            <p><small>${new Date(data.send_date).toLocaleString()}</small></p>
            `;
        } catch (err) {
            document.getElementById('lastMessage').innerText = 'ìµœê·¼ ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            console.error(err);
        }
        }

        // âœ… ì„œë²„ ì—°ê²° í›„ ë°© ì…ì¥
        socket.on("connect", () => {
            socket.emit("joinRoom", {
                r_id: roomId,
                u2_id
            });
        });

        // âœ… ì„œë²„ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì¶œë ¥
        socket.on("receiveMessage", (data) => {
            const chatMessages = document.getElementById("chatMessages");
            const messageElement = document.createElement("div");
            const utcDate = new Date(data.send_date);
            const kstDate = new Date(utcDate.getTime() + (9 * 60 * 60 * 1000));
            const formattedDate = kstDate.toISOString().slice(0, 19).replace('T', ' ');
            // messageElement.textContent = `[${data.send_date}] ${data.u1_id}: ${data.message_contents}`;
            messageElement.textContent = `[${formattedDate}] ${data.u1_id}: ${data.message_contents}`;

            if (data.image) {
                const img = document.createElement("img");
                // img.src = `data:image/jpeg;base64,${data.image}`;
                img.src = `data:${data.image_type};base64,${data.image}`;
                img.style.maxWidth = "200px";
                messageElement.appendChild(img);
            }

            chatMessages.appendChild(messageElement);
        });

        // âœ… ë©”ì‹œì§€ ì „ì†¡ (ì†Œì¼“ ê¸°ë°˜)
        function sendMessage() {
            console.log("âœ… sendMessage() í˜¸ì¶œë¨(chat.html:433)");
            const messageInput = document.getElementById("messageInput");
            const fileInput = document.getElementById("fileInput");
            const message = messageInput.value.trim();
            const file = fileInput.files[0];

            if (!message && !file) {
                alert("ë©”ì‹œì§€ë‚˜ íŒŒì¼ ì¤‘ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }

            // íŒŒì¼ì´ ìˆìœ¼ë©´ base64ë¡œ ì¸ì½”ë”© í›„ ì „ì†¡
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const base64Image = event.target.result.split(',')[1]; // base64ë§Œ ì¶”ì¶œ

                    socket.emit('sendMessage', {
                        message_contents: message || null,
                        r_id: roomId,
                        // u1_id,
                        u2_id,
                        image: base64Image,
                        image_type: file.type
                    });
                    console.log("ğŸ“¤ ì´ë¯¸ì§€ í¬í•¨ ë©”ì‹œì§€ ì „ì†¡(chat.html:458):", {
                        message_contents: message || null,
                        r_id: roomId,
                        u2_id,
                        image_type: file.type
                    });
                };
                reader.readAsDataURL(file);
            } else {
                // íŒŒì¼ ì—†ìœ¼ë©´ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ë§Œ ì „ì†¡
                socket.emit('sendMessage', {
                    message_contents: message,
                    r_id: roomId,
                    // u1_id,
                    u2_id
                });
                console.log("ğŸ“¤ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡(chat.html:474):", {
                    message_contents: message,
                    r_id: roomId,
                    u2_id
                });
            }

            // ì…ë ¥ ì´ˆê¸°í™”
            messageInput.value = "";
            fileInput.value = null;
        }

        // âœ… ë°© ë‚˜ê°€ê¸°
        function goBackToRoomList() {
            window.location.href = "/rooms.html";
        }

        // âœ… ë°© ë¯¸ì…˜ ì¶œë ¥
        function printRoomMission() {
            const u2_id = document.getElementById('u2_id_input').value;

            fetch('/nodetest/api/missions/printRoomMission', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify({ u2_id }),
            })
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById("roomMissionList");
                list.innerHTML = "";

                data.missions?.forEach(m => {
                    const li = document.createElement("li");
                    li.textContent = `ë¯¸ì…˜: ${m.title}, ë§ˆê°ì¼: ${m.deadline}, ìˆ˜í–‰ì: ${m.performer}`;
                    list.appendChild(li);
                });
            })
            .catch(error => {
                console.error("ë¯¸ì…˜ ì¶œë ¥ ì˜¤ë¥˜:", error);
            });
        }

        loadLastMessage();
    </script>
</body>
</html>
