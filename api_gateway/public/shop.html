<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìƒì </title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    .item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .item img { max-width: 100px; }
  </style>
</head>
<body>

  <h1>ğŸ›’ ìƒì </h1>
  <p><strong>ë‚´ í¬ì¸íŠ¸:</strong> <span id="userPoints">ë¡œë”© ì¤‘...</span></p>

  <div id="itemList"></div>

  <script>
    const jwtToken = localStorage.getItem('jwt_token');
    let currentUserId = null;

    // âœ… ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    async function fetchUserInfoAndPoints() {
      try {
        const res = await fetch(`/shop/points/${userId}`, {
          headers: {
            'Authorization': `Bearer ${jwtToken}`
          }
        });

        if (!res.ok) throw new Error("ì‚¬ìš©ì ì •ë³´ ìš”ì²­ ì‹¤íŒ¨");

        const user = await res.json();
        currentUserId = user.u_id;

        const pointsRes = await fetch(`/nodetest/shop/user-info/user-points/${currentUserId}`, {
          headers: {
            'Authorization': `Bearer ${jwtToken}`
          }
        });
        if (!pointsRes.ok) throw new Error("í¬ì¸íŠ¸ ì¡°íšŒ ì‹¤íŒ¨");

        const pointsData = await pointsRes.json();
        document.getElementById('userPoints').innerText = `${pointsData.points} P`;
      } catch (err) {
        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        window.location.href = '/';
      }
    }

    // âœ… ì•„ì´í…œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadItems() {
      const res = await fetch('/nodetest/shop/items', {
          headers: {
            'Authorization': `Bearer ${jwtToken}`
          }
        });
      const items = await res.json();

      const list = document.getElementById('itemList');
      list.innerHTML = items.map(item => `
        <div class="item">
          <img src="${item.image_url}" alt="${item.name}">
          <p><strong>${item.name}</strong> (${item.price}P)</p>
          <p>${item.description}</p>
          <button onclick="buyItem(${item.item_id})">êµ¬ë§¤</button>
        </div>
      `).join('');
    }

    // âœ… ì•„ì´í…œ êµ¬ë§¤
    async function buyItem(itemId) {
      if (!currentUserId) return alert("ì‚¬ìš©ì ì •ë³´ ì—†ìŒ");

      const res = await fetch('/nodetest/shop/buy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}`},
        body: JSON.stringify({ user_id: currentUserId, item_id: itemId })
      });

      const result = await res.json();
      alert(result.message);
      fetchUserInfoAndPoints(); // êµ¬ë§¤ í›„ í¬ì¸íŠ¸ ê°±ì‹ 
    }

    // ì´ˆê¸° ì‹¤í–‰
    fetchUserInfoAndPoints();
    loadItems();
  </script>

</body>
</html>