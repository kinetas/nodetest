

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๋ก๊ทธ์ธ ํ์คํธ</title>
</head>
<body>
    <h1>๋ก๊ทธ์ธ ํ์คํธ</h1>
    <form id="loginForm">
        <input type="text" id="u_id" placeholder="์์ด๋" required><br><br>
        <input type="password" id="u_password" placeholder="๋น๋ฐ๋ฒํธ" required><br><br>
        <!-- โ JWT ๋ฐฉ์์์๋ ๋๋ฐ์ด์ค ํํฐ ์๋ฅ ํ๋ ์๊ฑฐ -->
        <!-- <input type="text" id="token" placeholder="ํํฐ" required><br><br> -->
        <button type="submit">๋ก๊ทธ์ธ</button>
    </form>
    <div id="result"></div>
    
    <!-- ํ์๊ฐ์ ๋ฒํผ -->
    <button id="registerButton">ํ์๊ฐ์</button>
    
    <!-- ์์ด๋/๋น๋ฐ๋ฒํธ ์ฐพ๊ธฐ ๋ฒํผ -->
    <button id="findInfoButton">์์ด๋/๋น๋ฐ๋ฒํธ ๋ณ๊ฒฝ</button>

    <!-- โ Keycloak ๋ก๊ทธ์ธ ๋ฒํผ -->
    <button id="keycloakLoginButton">Keycloak ๋ก๊ทธ์ธ</button>

    <!-- โ Keycloak ์ง์ ๋ก๊ทธ์ธ ๋ฒํผ -->
    <button id="keycloakDirectLoginButton">Keycloak ์ง์ ๋ก๊ทธ์ธ</button>

    <script>
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // โ ๋ณ์๋ช ๋ณ๊ฒฝ: JWT ๊ธฐ๋ฐ loginToken API๋ userId, password ์ฌ์ฉ
            const userId = document.getElementById('u_id').value;
            const password = document.getElementById('u_password').value;

            // โ JWT ๊ธฐ๋ฐ loginToken ๋ผ์ฐํธ๋ก ์์ฒญ
            fetch('/api/auth/loginToken', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ userId, password }),
            })
            .then(response => response.json())
            .then(data => {
                console.log("๐ ๋ก๊ทธ์ธ ์๋ต ๋ฐ์ดํฐ:", data); // โ ์ด๊ฒ ํต์ฌ
                console.log("๐ ์๋ต ํํฐ:", data.token);   // โ undefined๋ฉด ์๋ฒ ์๋ต ๋ฌธ์
                if (data.token) {
                    // localStorage์ ํํฐ ์์ฅ
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('userId', data.user.u_id); // ์ฌ์ฉ์ ID๋ ์์ฅ ๊ฐ๋ฅ

                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1000); // 100ms ์ง์ฐ ํ ์ด๋
                } else {
                    document.getElementById('result').textContent = data.message || '๋ก๊ทธ์ธ ์คํจ';
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                document.getElementById('result').textContent = `๋ก๊ทธ์ธ ์ค ์ค๋ฅ (${error})๊ฐ ๋ฐ์ํ์ต๋๋ค.`;
            });
        });

        // โ Keycloak ์ง์ ๋ก๊ทธ์ธ ๋ฒํผ ํธ๋ค๋ฌ
        document.getElementById('keycloakDirectLoginButton').addEventListener('click', () => {
            const username = document.getElementById('u_id').value;
            const password = document.getElementById('u_password').value;

            fetch('/api/auth/keycloak-direct-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const accessToken = data.accessToken;
                    const idToken = data.idToken;
                    console.log("accesstoken: ", accessToken);
                    console.log("idToken: ", idToken);
                    localStorage.setItem('access_token', accessToken);
                    localStorage.setItem('id_token', idToken);
                    // โ ์ฐ๋ฆฌ ์๋ฒ JWT ๋ฐ๊ธ ์์ฒญ ์ถ๊ฐ
                    return fetch('/api/auth/issueJwtFromKeycloak', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ accessToken }),
                    });
                } else {
                    throw new Error(data.message || 'Keycloak ๋ก๊ทธ์ธ ์คํจ');
                }
            })
            .then(res => res.json())
            .then(jwt => {
                if (jwt.success && jwt.token) {
                    localStorage.setItem('jwt_token', jwt.token); // โ JWT ์์ฅ
                    alert('โ Keycloak + JWT ๋ก๊ทธ์ธ ์๋ฃ!');
                    window.location.href = '/dashboard'; // โ JWT๊น์ง ๋ฐ์ ํ ์ด๋
                } else {
                    throw new Error(jwt.message || 'JWT ๋ฐ๊ธ ์คํจ');
                }
            })
            .catch((error) => {
                console.error('๋ก๊ทธ์ธ ์ค๋ฅ:', error);
                alert('๋ก๊ทธ์ธ ์ค๋ฅ: ' + error.message);
            });
        });

        // ํ์๊ฐ์ ํ์ด์ง๋ก ์ด๋
        document.getElementById('registerButton').addEventListener('click', function() {
            window.location.href = '/register';
        });

        // ์์ด๋/๋น๋ฐ๋ฒํธ ์ฐพ๊ธฐ ํ์ด์ง๋ก ์ด๋
        document.getElementById('findInfoButton').addEventListener('click', function() {
            window.location.href = '/findinfo';
        });

        // document.getElementById('keycloakLoginButton').addEventListener('click', () => {
        //     // โ Keycloak ๋ก๊ทธ์ธ URL๋ก ๋ฆฌ๋๋์
        //     window.location.href = "http://27.113.11.48:8080/realms/master/protocol/openid-connect/auth" +
        //         "?client_id=nodetest" +
        //         "&response_type=id_token token" +     // โ Implicit flow โ ์ง์ id_token, access_token ๋ฐ์
        //         "&scope=openid" +
        //         "&nonce=nonce123" + 
        //         "&redirect_uri=http://27.113.11.48:3000/dashboard";
        // });
        document.getElementById('keycloakLoginButton').addEventListener('click', () => {
        // ๋ฐฑ์๋์์ ๋ก๊ทธ์ธ URL์ ๋ฐ์์ด
            fetch('/api/auth/keycloak-login-url')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.loginUrl) {
                        window.location.href = data.loginUrl;
                    } else {
                        alert('Keycloak ๋ก๊ทธ์ธ URL์ ๊ฐ์ธ์ค์ง ๋ชปํ์ต๋๋ค.');
                    }
                })
                .catch((error) => {
                    console.error('Keycloak ๋ก๊ทธ์ธ ์์ฒญ ์ค๋ฅ:', error);
                    alert('Keycloak ๋ก๊ทธ์ธ ์ค ์ค๋ฅ ๋ฐ์');
                });
        });
    </script>
</body>
</html>
