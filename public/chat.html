<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>채팅방</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>
    <h1>채팅방</h1>
    <div id="chatMessages">메시지 목록</div>
    <input type="text" id="messageInput" placeholder="메시지를 입력하세요">
    <input type="file" id="fileInput">
    <button onclick="sendMessage()">전송</button>
    <button onclick="goBackToRoomList()">나가기</button>
    

    <h1>방 미션 출력</h1>
    <div>
        <input type="text" id="u2_id_input" placeholder="상대방 ID 입력"    >
        <button onclick="printRoomMission()">방 미션 출력</button>
    </div>
    <h2>미션 목록</h2>
    <ul id="roomMissionList"></ul>
    

    <script>

        // // JWT 기반 인증 수정: 토큰 가져오기
        // const token = localStorage.getItem('jwt');
        // if (!token) {
        //     alert("로그인이 필요합니다.");
        //     window.location.href = '/';
        // }
        
        // URL에서 roomId 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('r_id'); // URL 파라미터에서 roomId 추출
        const socket = io("http://54.180.54.31:3001",{
            path: '/socket.io'
        });

        socket.on("connect", () => {
            console.log("서버에 연결되었습니다.");
            socket.emit("joinRoom", { r_id: roomId });
        });

        // // =========== 수정 JWT =============
        // socket.on("connect", () => {
        //     console.log("서버에 연결되었습니다.");
        //     socket.emit("joinRoom", { r_id: roomId }); // JWT 인증 후 방 입장
        // });

        socket.on("receiveMessage", (data) => {
            const chatMessages = document.getElementById("chatMessages");
            const messageElement = document.createElement("div");
            messageElement.textContent = `[${data.send_date}] ${data.u1_id}: ${data.message}`;
            chatMessages.appendChild(messageElement);


             // 이미지가 포함된 경우 이미지를 표시
            if (data.image) {
                const imageElement = document.createElement("img");
                imageElement.src = `data:image/jpeg;base64,${arrayBufferToBase64(data.image.data)}`;
                imageElement.style.maxWidth = "200px";
                messageElement.appendChild(imageElement);
            }
            chatMessages.appendChild(messageElement);

        });
        
        function sendMessage() {
            // 메시지 입력 필드를 불러오기
            const messageInput = document.getElementById("messageInput");
            const fileInput = document.getElementById("fileInput"); // 파일 입력 필드 가져오기
            const file = fileInput.files[0]; // 선택된 파일 가져오기

            if (!messageInput) {
                console.error("Cannot find message input element.");
                return;
            }
            const message = messageInput.value;

            // 로그인된 사용자 ID 가져오기
            const u1_id = sessionStorage.getItem('user_id'); // =========== 수정 JWT ui_id 제거 =============
            const urlParams = new URLSearchParams(window.location.search);
            const r_id = urlParams.get('r_id');
            const u2_id = urlParams.get('u2_id');
            if (!u1_id) {
                console.error("User ID not found in session storage.");
                return;
            }
            // 메시지가 비어 있는지 확인
            if (message.trim() === "") {
                alert("메시지를 입력하세요.");
                return;
            }

            // // =========== 수정 JWT =============
            // if (!message.trim()) {
            //     alert("메시지를 입력하세요.");
            //     return;
            // }

            // 메시지 전송
            socket.emit("sendMessage", { message_contents: message,r_id:r_id, u1_id:u1_id,u2_id:u2_id });


            // // =========== 수정 JWT =============
            // if (!message.trim()) {
            //     alert("메시지를 입력하세요.");
            //     return;
            // }
        // FormData를 사용하여 메시지와 파일을 함께 전송
            const formData = new FormData();
            formData.append('message_contents', message);
            formData.append('u1_id', u1_id);
            formData.append('u2_id', u2_id);
            formData.append('r_id', r_id);
            if (file) {
                formData.append('file', file);
            }

            fetch('/chat/send-message', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    console.log(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        // 메시지 입력란 비우기
            messageInput.value = "";
        }
        // 방 목록으로 나가기 함수
        function goBackToRoomList() {
            window.location.href = '/rooms.html';
        }
            //방미션출력
        function printRoomMission() {
            const u2_id = document.getElementById('u2_id_input').value;

            fetch('/api/missions/printRoomMission', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Authorization: `Bearer ${token}`, // JWT 기반 인증 헤더 추가
                },
                body: JSON.stringify({ u2_id }),
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message); });
                    }
                    return response.json();
                })
                .then(data => {
                    const roomMissionListElement = document.getElementById('roomMissionList');
                    roomMissionListElement.innerHTML = '';

                    if (data.missions && data.missions.length > 0) {
                        data.missions.forEach(mission => {
                            const listItem = document.createElement('li');
                            listItem.textContent = `미션: ${mission.title}, 마감일: ${mission.deadline}, 수행자: ${mission.performer}`;
                            roomMissionListElement.appendChild(listItem);
                        });
                    } else {
                        roomMissionListElement.textContent = '해당 방에 미션이 없습니다.';
                    }
                })
                .catch(error => {
                    console.error('미션 출력 오류:', error);
                    document.getElementById('roomMissionList').textContent = `오류 발생: ${error.message}`;
                });
        }
    </script>
</body>
</html>